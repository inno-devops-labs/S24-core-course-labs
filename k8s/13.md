# Lab 13

## Task 1

```bash
$ helm install --dry-run --debug time-app .
install.go:218: [debug] Original chart version: ""
install.go:235: [debug] CHART PATH: C:\Users\korol\PycharmProjects\S24-DevOps-Labs\k8s\time-app

NAME: time-app
LAST DEPLOYED: Wed May  1 04:08:52 2024
NAMESPACE: default
STATUS: pending-install
REVISION: 1
USER-SUPPLIED VALUES:
{}

COMPUTED VALUES:
affinity: {}
autoscaling:
  enabled: false
  maxReplicas: 100
  minReplicas: 1
  targetCPUUtilizationPercentage: 80
fullnameOverride: ""
image:
  pullPolicy: IfNotPresent
  repository: zaqbez39me/moscow-time-app
  tag: visits_updated
imagePullSecrets: []
ingress:
  annotations: {}
  className: ""
  enabled: false
  hosts:
  - host: chart-example.local
    paths:
    - path: /
      pathType: ImplementationSpecific
  tls: []
livenessProbe:
  httpGet:
    path: /
    port: http
nameOverride: ""
nodeSelector: {}
podAnnotations: {}
podLabels: {}
podSecurityContext: {}
readinessProbe:
  httpGet:
    path: /
    port: http
replicaCount: 3
resources: {}
securityContext: {}
service:
  port: 80
  type: NodePort
serviceAccount:
  annotations: {}
  automount: true
  create: true
  name: internal-app
tolerations: []
volumeClaimTemplates:
- metadata:
    name: visits
  spec:
    accessModes:
    - ReadWriteOnce
    resources:
      requests:
        storage: 10Mi
volumeMounts:
- mountPath: /config
  name: config-volume
  readOnly: true
- mountPath: /code/vol
  name: visits
volumes:
- configMap:
    items:
    - key: config
      path: config.json
    name: config
  name: config-volume

HOOKS:
---
# Source: time-app/templates/post-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: postinstall-hook
   annotations:
       "helm.sh/hook": "post-install"
       "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: post-install-container
    image: busybox
    imagePullPolicy: Always
    command: ['sh', '-c', 'echo The post-install hook is running && sleep 15' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: time-app/templates/pre-install-hook.yaml
apiVersion: v1
kind: Pod
metadata:
   name: preinstall-hook
   annotations:
       "helm.sh/hook": "pre-install"
       "helm.sh/hook-delete-policy": hook-succeeded
spec:
  containers:
  - name: pre-install-container
    image: busybox
    imagePullPolicy: IfNotPresent
    command: ['sh', '-c', 'echo The pre-install hook is running && sleep 20' ]
  restartPolicy: Never
  terminationGracePeriodSeconds: 0
---
# Source: time-app/templates/tests/test-connection.yaml
apiVersion: v1
kind: Pod
metadata:
  name: "time-app-test-connection"
  labels:
    helm.sh/chart: time-app-0.1.0
    app.kubernetes.io/name: time-app
    app.kubernetes.io/instance: time-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
  annotations:
    "helm.sh/hook": test
spec:
  containers:
    - name: wget
      image: busybox
      command: ['wget']
      args: ['time-app:80']
  restartPolicy: Never
MANIFEST:
---
# Source: time-app/templates/serviceaccount.yaml
apiVersion: v1
kind: ServiceAccount
metadata:
  name: internal-app
  labels:
    helm.sh/chart: time-app-0.1.0
    app.kubernetes.io/name: time-app
    app.kubernetes.io/instance: time-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
automountServiceAccountToken: true
---
# Source: time-app/templates/config.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: config
data:
  config: |-
    {

    }
---
# Source: time-app/templates/service.yaml
apiVersion: v1
kind: Service
metadata:
  name: time-app
  labels:
    helm.sh/chart: time-app-0.1.0
    app.kubernetes.io/name: time-app
    app.kubernetes.io/instance: time-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  type: NodePort
  ports:
    - port: 80
      targetPort: http
      protocol: TCP
      name: http
  selector:
    app.kubernetes.io/name: time-app
    app.kubernetes.io/instance: time-app
---
# Source: time-app/templates/statefulset.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: time-app
  labels:
    helm.sh/chart: time-app-0.1.0
    app.kubernetes.io/name: time-app
    app.kubernetes.io/instance: time-app
    app.kubernetes.io/version: "1.16.0"
    app.kubernetes.io/managed-by: Helm
spec:
  replicas: 3
  selector:
    matchLabels:
      app.kubernetes.io/name: time-app
      app.kubernetes.io/instance: time-app
  template:
    metadata:
      labels:
        helm.sh/chart: time-app-0.1.0
        app.kubernetes.io/name: time-app
        app.kubernetes.io/instance: time-app
        app.kubernetes.io/version: "1.16.0"
        app.kubernetes.io/managed-by: Helm
    spec:
      serviceAccountName: internal-app
      securityContext:
        {}
      containers:
        - name: time-app
          securityContext:
            {}
          image: "zaqbez39me/moscow-time-app:visits_updated"
          imagePullPolicy: IfNotPresent
          ports:
            - name: http
              containerPort: 80
              protocol: TCP
          livenessProbe:
            httpGet:
              path: /
              port: http
          readinessProbe:
            httpGet:
              path: /
              port: http
          resources:
            {}
          volumeMounts:
            - mountPath: /config
              name: config-volume
              readOnly: true
            storage: 10Mi

NOTES:
1. Get the application URL by running these commands:
  export NODE_PORT=$(kubectl get --namespace default -o jsonpath="{.spec.ports[0].nodePort}" services time-app)
  export NODE_IP=$(kubectl get nodes --namespace default -o jsonpath="{.items[0].status.addresses[0].address}")
  echo http://$NODE_IP:$NODE_PORT

```

# Task 2

## Point 1
### `kubectl get po,sts,svc,pvc`
```bash
NAME                                       READY   STATUS    RESTARTS      AGE
pod/helm-hooks-time-app-586fbdfcb7-mldq8   1/1     Running   7 (63m ago)   21d
pod/time-app-0                             1/1     Running   0             23s
pod/time-app-1                             1/1     Running   0             20s
pod/time-app-2                             0/1     Running   0             10s
pod/vault-0                                1/1     Running   2 (63m ago)   14d
pod/vault-agent-injector-dbfc5cd77-cr974   1/1     Running   2 (63m ago)   14d

NAME                        READY   AGE
statefulset.apps/time-app   2/3     23s
statefulset.apps/vault      1/1     14d

NAME                               TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)             AGE
service/helm-hooks-time-app        ClusterIP   10.96.51.249     <none>        80/TCP              21d
service/kubernetes                 ClusterIP   10.96.0.1        <none>        443/TCP             21d
service/time-app                   NodePort    10.99.42.3       <none>        80:30177/TCP        23s
service/vault                      ClusterIP   10.96.206.124    <none>        8200/TCP,8201/TCP   14d
service/vault-agent-injector-svc   ClusterIP   10.104.179.183   <none>        443/TCP             14d
service/vault-internal             ClusterIP   None             <none>        8200/TCP,8201/TCP   14d

NAME                                      STATUS   VOLUME                                     CAPACITY   ACCESS MODES   STORAGECLASS   AGE
persistentvolumeclaim/visits-time-app-0   Bound    pvc-32d7e0d9-345a-445b-b43e-b14b9264a97b   10Mi       RWO            standard       57m
persistentvolumeclaim/visits-time-app-1   Bound    pvc-e76fd44c-6506-45df-8dd3-367fbc96b93d   10Mi       RWO            standard       15m
persistentvolumeclaim/visits-time-app-2   Bound    pvc-71efc0f2-6bdc-4c97-ab85-975dd77b49f2   10Mi       RWO            standard       15m
```

### `minikube service time-app`

```bash
W0501 04:12:30.563584    7568 main.go:291] Unable to resolve the current Docker CLI context "default": context "default": context not found: open C:\Users\korol\.docker\contexts\meta\37a8eec1ce19687d132fe29051dca629d164e2c4958ba141d5f4133a33f0688f\meta.json: The sys
tem cannot find the path specified.
|-----------|----------|-------------|---------------------------|
| NAMESPACE |   NAME   | TARGET PORT |            URL            |
|-----------|----------|-------------|---------------------------|
| default   | time-app | http/80     | http://192.168.49.2:30177 |
|-----------|----------|-------------|---------------------------|
ðŸƒ  Starting tunnel for service time-app.
|-----------|----------|-------------|------------------------|
| NAMESPACE |   NAME   | TARGET PORT |          URL           |
|-----------|----------|-------------|------------------------|
| default   | time-app |             | http://127.0.0.1:62916 |
|-----------|----------|-------------|------------------------|
ðŸŽ‰  Opening service default/time-app in default browser...
â—  Because you are using a Docker driver on windows, the terminal needs to be open to run it.

```

### Usage of `kubectl exec pod/time-app-0 -- cat /code/vol/visits` and differences

```bash
(venv) PS C:\Users\korol\PycharmProjects\S24-DevOps-Labs> kubectl exec pod/time-app-0 -- cat /code/vol/visits
232
```

```bash
(venv) PS C:\Users\korol\PycharmProjects\S24-DevOps-Labs> kubectl exec pod/time-app-1 -- cat /code/vol/visits
212
```

```bash
(venv) PS C:\Users\korol\PycharmProjects\S24-DevOps-Labs> kubectl exec pod/time-app-2 -- cat /code/vol/visits
210
```

Each pod has different number from other pods because the load on our service distributed between pods arbitrarily.

## Point 2

Ordering guarantees are unnecessary in our application because the pods are independent of each other. In conditions 
when we have full isolation of pods there is no need to worry about ordering guarantees.
